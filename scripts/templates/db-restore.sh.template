#!/bin/bash

# Database Restore Script
# 
# SETUP:
# 1. Copy this file: cp scripts/templates/db-restore.sh.template scripts/db-restore.sh
# 2. Edit scripts/db-restore.sh and update credentials
# 3. Make executable: chmod +x scripts/db-restore.sh

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration - UPDATE THESE VALUES
DB_NAME="doit_db"                    # Update if different
DB_USER="doit_user"                  # Update if different
DB_PASSWORD="YOUR_PASSWORD_HERE"     # âš ï¸ REQUIRED: Set your password
CONTAINER_NAME="doit-dev-postgres"   # Update if different

# Check if backup file is provided
if [ -z "$1" ]; then
    echo -e "${RED}Error: No backup file specified${NC}"
    echo "Usage: $0 <backup-file.sql.gz> [--replace|--merge]"
    echo ""
    echo "Options:"
    echo "  --replace  : Drop existing database and restore (default)"
    echo "  --merge    : Keep existing data and add new data from backup"
    echo ""
    echo "Examples:"
    echo "  $0 db-backups/doit_backup_20240101_120000.sql.gz"
    echo "  $0 db-backups/doit_backup_20240101_120000.sql.gz --merge"
    exit 1
fi

BACKUP_FILE="$1"
MODE="${2:---replace}"

# Check if backup file exists
if [ ! -f "$BACKUP_FILE" ]; then
    echo -e "${RED}Error: Backup file not found: $BACKUP_FILE${NC}"
    exit 1
fi

# Check if container is running
if ! podman ps | grep -q "$CONTAINER_NAME"; then
    echo -e "${RED}Error: Container $CONTAINER_NAME is not running${NC}"
    echo "Start it with: podman-compose -f docker-compose.dev.yml up -d"
    exit 1
fi

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  Database Restore${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "Backup file: ${YELLOW}$BACKUP_FILE${NC}"
echo -e "Mode: ${YELLOW}$MODE${NC}"
echo -e "Target DB: ${YELLOW}$DB_NAME${NC}"
echo ""

if [ "$MODE" == "--replace" ]; then
    echo -e "${RED}âš ï¸  WARNING: This will DELETE all existing data!${NC}"
else
    echo -e "${YELLOW}â„¹ï¸  This will merge backup data with existing data.${NC}"
    echo -e "${YELLOW}   Conflicts will be skipped (existing data preserved).${NC}"
fi

echo ""
read -p "Continue? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Cancelled."
    exit 0
fi

# Create temp directory for extraction
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

echo -e "${YELLOW}ğŸ“¦ Extracting backup...${NC}"

# Extract the backup
if [[ "$BACKUP_FILE" == *.gz ]]; then
    gunzip -c "$BACKUP_FILE" > "$TEMP_DIR/backup.sql"
else
    cp "$BACKUP_FILE" "$TEMP_DIR/backup.sql"
fi

if [ "$MODE" == "--replace" ]; then
    echo -e "${YELLOW}ğŸ—‘ï¸  Dropping existing database...${NC}"
    
    # Terminate existing connections
    podman exec "$CONTAINER_NAME" psql -U "$DB_USER" -d postgres -c \
        "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$DB_NAME' AND pid <> pg_backend_pid();" \
        2>/dev/null || true
    
    # Drop and recreate database
    podman exec "$CONTAINER_NAME" psql -U "$DB_USER" -d postgres -c "DROP DATABASE IF EXISTS $DB_NAME;" 2>/dev/null || true
    podman exec "$CONTAINER_NAME" psql -U "$DB_USER" -d postgres -c "CREATE DATABASE $DB_NAME;"
    
    echo -e "${YELLOW}ğŸ“¥ Restoring database...${NC}"
    
    # Restore the backup
    podman exec -i "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" < "$TEMP_DIR/backup.sql" 2>&1 | grep -v "ERROR.*already exists" || true
    
else
    echo -e "${YELLOW}ğŸ”€ Merging data...${NC}"
    echo -e "${YELLOW}   Note: Duplicate entries will be skipped${NC}"
    
    # For merge mode, restore with errors suppressed for conflicts
    podman exec -i "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" < "$TEMP_DIR/backup.sql" 2>&1 | \
        grep -v "ERROR.*duplicate key" | \
        grep -v "ERROR.*already exists" || true
fi

# Verify the restore
echo -e "${YELLOW}âœ“ Verifying restore...${NC}"

# Count records in main tables
CATEGORIES=$(podman exec "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" -t -c "SELECT COUNT(*) FROM categories;" 2>/dev/null | xargs)
TODOS=$(podman exec "$CONTAINER_NAME" psql -U "$DB_USER" -d "$DB_NAME" -t -c "SELECT COUNT(*) FROM todos;" 2>/dev/null | xargs)

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ“ Restore completed successfully!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "Database: ${YELLOW}$DB_NAME${NC}"
echo -e "Categories: ${YELLOW}$CATEGORIES${NC}"
echo -e "Todos: ${YELLOW}$TODOS${NC}"
echo ""
echo -e "${GREEN}Your development database is now updated!${NC}"
